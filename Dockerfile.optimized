# syntax=docker/dockerfile:1.7
# OPTIMIZED BUILD: Jina Embeddings v4 vLLM Worker for RunPod Serverless
#
# Build with: DOCKER_BUILDKIT=1 docker build -f Dockerfile.optimized -t jina-embeddings-v4-runpod .
#
# With registry cache:
#   docker buildx build -f Dockerfile.optimized \
#     --cache-from type=registry,ref=yourrepo/jina-cache \
#     --cache-to type=registry,ref=yourrepo/jina-cache,mode=max \
#     -t jina-embeddings-v4-runpod .
#
# Get your Jina AI API key for free: https://jina.ai/?sui=apikey

FROM runpod/worker-v1-vllm:stable-cuda12.1.0

# Environment variables (single layer)
ENV MODEL_NAME="jinaai/jina-embeddings-v4-vllm-retrieval" \
    MAX_MODEL_LEN=8192 \
    GPU_MEMORY_UTILIZATION=0.9 \
    DTYPE=float16 \
    VLLM_USE_V1=0 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=0 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install dependencies with cache mount (persists between builds)
RUN --mount=type=cache,target=/root/.cache/pip,sharing=locked \
    pip install Pillow requests

# Copy source code last (changes most frequently)
# --link creates layer without unpacking previous layers (faster)
COPY --link src/ /src/

WORKDIR /src

CMD ["python3", "-u", "handler.py"]
